<!DOCTYPE HTML>
<html lang="zh">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="../../css/style.css">
<title>Miracle Nikki - 镇魂曲活动</title>
<style>
.remark{font-size:80%;}
td {text-align:left;}
</style>
<script type="text/javascript">
//活动结束时间
var time_end=new Date("8/29/2016 23:59:59 GMT+0800").getTime();
//默认掉率-少女/公主
var def_drop=[34,34];
//套装数据
var set=['梦鹦鹉之歌','血鹦鹉之火'];
//相关衣柜
var wardrobe = [
  ['雪之聆歌·珍稀','发型','728','5','','','','','','','','','','','','进727','梦鹦鹉之歌'],
  ['雪之聆歌·华丽','发型','727','5','','','','','','','','','','','','进726',''],
  ['雪之聆歌','发型','726','5','','','','','','','','','','','','2-9公',''],
  ['梦鹦鹉之歌·珍稀','连衣裙','611','5','','','','','','','','','','','','进610','梦鹦鹉之歌'],
  ['梦鹦鹉之歌·华丽','连衣裙','610','5','','','','','','','','','','','','进609',''],
  ['梦鹦鹉之歌','连衣裙','609','5','','','','','','','','','','','','5-10公',''],
  ['自由之羽·珍稀','鞋子','663','5','','','','','','','','','','','','进612','梦鹦鹉之歌'],
  ['自由之羽·华丽','鞋子','662','5','','','','','','','','','','','','进611',''],
  ['自由之羽','鞋子','661','5','','','','','','','','','','','','3-7公',''],
  ['金丝笼·珍稀','饰品-手持·左','1014','5','','','','','','','','','','','','进1013','梦鹦鹉之歌'],
  ['金丝笼·华丽','饰品-手持·左','1013','5','','','','','','','','','','','','进1010',''],
  ['金丝笼','饰品-手持·左','1010','5','','','','','','','','','','','','2-7少',''],
  ['纯真羽冠·华丽','饰品-头饰','1015','5','','','','','','','','','','','','进1011','梦鹦鹉之歌'],
  ['纯真羽冠','饰品-头饰','1011','5','','','','','','','','','','','','4-7少',''],
  ['纯白信羽·华丽','饰品-耳饰','1016','5','','','','','','','','','','','','进1012','梦鹦鹉之歌'],
  ['纯白信羽','饰品-耳饰','1012','5','','','','','','','','','','','','5-6公',''],
  ['红颊','饰品-特殊·纹身','1017','5','','','','','','','','','','','','设计图','梦鹦鹉之歌'],
  ['空灵信仰','妆容','034','5','','','','','','','','','','','','6-1少','梦鹦鹉之歌'],
  ['血之夜歌','发型','729','5','','','','','','','','','','','','定728','血鹦鹉之火'],
  ['血鹦鹉之火','连衣裙','612','5','','','','','','','','','','','','定611','血鹦鹉之火'],
  ['救赎乐章','鞋子','664','5','','','','','','','','','','','','定663','血鹦鹉之火'],
  ['荆棘之笼','饰品-手持·左','1018','5','','','','','','','','','','','','定1014','血鹦鹉之火'],
  ['玄风羽冠','饰品-头饰','1019','5','','','','','','','','','','','','定1015','血鹦鹉之火'],
  ['血露信羽','饰品-耳饰','1020','5','','','','','','','','','','','','定1016','血鹦鹉之火'],
  ['血之救赎','妆容','035','5','','','','','','','','','','','','定034','血鹦鹉之火'],
];
//进化数据(for显示)
var pattern_srare='5-3-1';
var pattern_rare='8-1';
//设计图数据
var pattern=[
  ['发型','729','发型','728',1,'染'],
  ['连衣裙','612','连衣裙','611',1,'染'],
  ['鞋子','664','鞋子','663',1,'染'],
  ['饰品','1018','饰品','1014',1,'染'],
  ['饰品','1019','饰品','1015',1,'染'],
  ['饰品','1020','饰品','1016',1,'染'],
  ['妆容','035','妆容','034',1,'染'],
  ['饰品','1017','饰品','1011',5,'设'],
  ['饰品','1017','饰品','1012',5,'设'],
  ['饰品','1017','妆容','034',10,'设'],
  ['发型','728','发型','727',3,'进'],
  ['发型','727','发型','726',5,'进'],
  ['连衣裙','611','连衣裙','610',3,'进'],
  ['连衣裙','610','连衣裙','609',5,'进'],
  ['鞋子','663','鞋子','662',3,'进'],
  ['鞋子','662','鞋子','661',5,'进'],
  ['饰品','1014','饰品','1013',3,'进'],
  ['饰品','1013','饰品','1010',5,'进'],
  ['饰品','1015','饰品','1011',8,'进'],
  ['饰品','1016','饰品','1012',8,'进'],
];
//V等级次数
var Vtimes=[1,1,2,2,3,3,5,10,15,20,25,25,28,28,30,35];
//***end of data***

var setCnt=[]; var types=[]; var names=[];
var reqCnt=[]; var parentInd=[]; var childInd=[]; var extraInd=[]; var extraAdded=[]; var linkP={};
var reqown=[]; var reqDif=[]; 
var savedInfo={};

var clothesId = function() {
  var ret = {};
  for (var i in wardrobe) {
	if(wardrobe[i]){
		ret[wardrobe[i][2]]=wardrobe[i];
	}
  }
  return ret;
}();

var clothesName = function() {
  var ret = {};
  for (var i in wardrobe) {
	if(wardrobe[i]){
		ret[wardrobe[i][0]]=wardrobe[i];
	}
  }
  return ret;
}();

window.onload = function(){
	setInterval(settime, 1000);
	init();
};

function init(ind){
	types=[]; names=[];
	for (var i in set){
		setCnt[i]=0;
		for (var j in wardrobe){
			if(wardrobe[j][16]==set[i]){
				names.push(wardrobe[j][0]);
				types.push(wardrobe[j][1]);
				setCnt[i]++;
			}
		}
	}
	var table='<form action=""><table border="1">';
	table+=tr(td('部位')+td('名称')+td('进化数量'));
	table+=tr(td(remark('*勾选代表已有/不需要部件'),'colspan="3"'));
	var pos=0;
	for (var s in set){
		table+=tr(td('<label><input type="checkbox" id="all'+s+'" onclick=checkall('+s+') >'+set[s]+'</label>','colspan="3"'));
		var cell1=''; var cell2='';
		for (i=pos;i<pos+setCnt[s];i++){
			var line=td(types[i])+td('<label><input type="checkbox" id="own'+i+'" onclick=calc() >'+names[i]+'</label>');
			line+=td(names[i].indexOf('珍稀')>-1 ? pattern_srare : (names[i].indexOf('华丽')>-1 ? pattern_rare : clothesName[names[i]][15].replace(/[0-9]/g,'').replace('-','')) );
			table+=tr(line);
		}
		pos+=setCnt[s];
	}
	table+='</table></form>';
	document.getElementById("table").innerHTML = table;
	
	var drop='<table border="1">';
	drop+=tr(td('')+td(''));
	drop+=tr(td('少女级掉率')+td(inputBox('drops','calc3()',3)+'%'));
	drop+=tr(td('公主级掉率')+td(inputBox('dropg','calc3()',3)+'%'));
	drop+=tr(td('剩余天数')+td(inputBox('remain_days','calc3()',3)+'<label><input type="checkbox" id="used_today" onclick="calc3()">今天已刷</label>'));
	drop+='</table>';
	document.getElementById("drop").innerHTML = drop;
	
	var date_now=new Date();
	var time_now=date_now.getTime();
	var time_d = Math.max(0,Math.floor((time_end-time_now)/1000/60/60/24));
	if(date_now.getHours()<5&&time_end-time_now>0){time_d+=1;}
	setVal("remain_days",time_d);
	
	//fill in values
	if(ind){
		for (var i in savedInfo['own']){
			if(parseInt(savedInfo['own'][i])>0){document.getElementById("own"+i).checked=true;}
		}
		for (var i in savedInfo['reqown']){
			reqown[i]=savedInfo['reqown'][i];
		}
		if(savedInfo['drops']){
			setVal("drops", savedInfo['drops'][0]);
			setVal("dropg", savedInfo['drops'][1]);
		}
	}else{
		if(getVal("drops")==0) {setVal("drops", def_drop[0]);}
		if(getVal("dropg")==0) {setVal("dropg", def_drop[1]);}
		for (var i in wardrobe){
			reqown[i]=0;
		}
	}
	
	calc();
}
function calc(){//reqCnt calc
	
	//find child
	linkP = function() {
	  var ret = {};
	  for (var i in wardrobe) {
		ret[i]=[];
		clearCnt();
		genFactor2(wardrobe[i][2],1);
		for (var j in wardrobe){
			if(reqCnt[j]>0&&!parentInd[j]) {ret[i].push([j,reqCnt[j]]);}
		}
	  }
	  return ret;
	}();
	//gen factor for all
	clearCnt();
	for (i=0;i<names.length;i++){
		if (!document.getElementById('own'+i).checked){
			for (var j in wardrobe){//mark sub as extra count needed
				if(wardrobe[j]==clothesName[names[i]]){
					extraInd[j]=1; break;
				}
			}
		}
	}
	do{
		var total=0;
		for (var i in wardrobe){//add extra count once only
			if(extraInd[i]&&(!extraAdded[i])){
				reqCnt[i]++; 
				genFactor2(wardrobe[i][2],1); 
				extraAdded[i]=1; 
				total++;
			}
		}
	}while(total>0);
	
	var input='<table border="1">';
	input+=tr(td('名称')+td('拥有数量')+td('还缺数量')+td('来源'));
	var name_prefix='';
	for (var i in wardrobe){
		if(childInd[i]) {
			input+=tr(td(name_prefix+wardrobe[i][0])+td(inputBox('reqown'+i,'calc2()',3))+td(parentInd[i]?'':reqCnt[i],'id="reqDif'+i+'"')+td(parentInd[i]?'':wardrobe[i][15]));
			if(wardrobe[i][15].indexOf('进')>-1){name_prefix+='&emsp;';}
			else{name_prefix='';}
		}
	}
	input+='</table>';
	document.getElementById("input").innerHTML = input;
	
	for (var i in wardrobe){
		if(document.getElementById('reqown'+i)) {setVal('reqown'+i, reqown[i]);}
	}
	
	calc2();
}
function calc2(){//diamond calc
	reqDif=[];
	for(var i in reqCnt){
		reqDif.push(reqCnt[i]);
	}
	/*for(var i in wardrobe){
		updreqown(i);
	}*/
	for (var i in wardrobe){
		if(document.getElementById('reqown'+i)){reqown[i]=Math.min(reqCnt[i],getVal('reqown'+i));}
		else{reqown[i]=0;}
		if(reqown[i]){
			if(linkP[i]){
				for (var j in linkP[i]){
					reqDif[linkP[i][j][0]]-=linkP[i][j][1]*reqown[i];
				}
			}
			reqDif[i]-=reqown[i];
		}
	}
	for (var i in wardrobe){
		reqDif[i]=Math.max(0,reqDif[i]);
		if(!parentInd[i]&&document.getElementById('reqDif'+i)) {document.getElementById('reqDif'+i).innerHTML=reqDif[i];}
	}
	
	calc3();
}
function calc3(){
	var dropk=[getVal('drops'),getVal('dropg')];
	var remain_days=getVal('remain_days');
	if (!document.getElementById('used_today').checked){remain_days++};
	var free_1day=3;
	var buy_per=30;
	var stamina_per=[4,6];
	
	var dropList=[];
	var kList=['少','公'];
	for (var k in kList){//sort by levels
		for(j=1;j<10;j++){//sort by chapters
			for (var i in wardrobe){
				if(wardrobe[i][15].indexOf(kList[k])>0&&j==wardrobe[i][15].substr(0,1)) {
					var times=Math.ceil(reqDif[i]*100/dropk[k]);
					var buy_times=Math.max(0,(times-free_1day*remain_days));
					var buy=Math.ceil(buy_times/3);
					var buy_perday=(buy/remain_days).toFixed(1);
					var diam=Math.ceil(buy_times/free_1day)*buy_per;
					var stam=stamina_per[k]*times;
					var Vreq=0;
					for(v=0;v<Vtimes.length;v++){
						Vreq=v;
						if(Vtimes[v]>=buy_perday){break;}
					}
					if(k==1) {dropList.push([wardrobe[i][15],wardrobe[i][0],times,buy_times,buy+'&emsp;/'+buy_perday,'V'+Vreq,diam,stam]);}
					else {dropList.push([wardrobe[i][15],wardrobe[i][0],times,'-','-','-','-',stam]);}
				}
			}
		}
	}
	var calcres='<table border="1">';
	calcres+=tr(td('关卡')+td('名称')+td('次数')+td('额外次数')+td('购买次数/每天')+td('V要求')+td('钻石')+td('体力'));
	var sum_diam=0; var sum_stam=0; var sum_Vreq=0;
	for(var i in dropList){
		var line='';
		for(var j in dropList[i]){
			line+=td(dropList[i][j]);
		}
		calcres+=tr(line);
		sum_diam+=(dropList[i][6]=='-'?0:dropList[i][6]);
		sum_stam+=(dropList[i][7]);
		if(parseInt(dropList[i][5].substr(1))>sum_Vreq){sum_Vreq=parseInt(dropList[i][5].substr(1));}
	}
	calcres+=tr(td('总计')+td('')+td('')+td('')+td('')+td('V'+sum_Vreq)+td(sum_diam)+td(sum_stam));
	calcres+='</table>';
	document.getElementById("calcres").innerHTML = calcres;
}
function loadSettings(){
	savedInfo={};
	savedInfo['own']=[];
	savedInfo['drops']=[];
	savedInfo['reqown']=[];
	if (typeof(Storage) !== "undefined" && localStorage.getItem("nikki_parrot")) {
		var loadString=localStorage.getItem("nikki_parrot");
		savedInfo['own']=getStoredStr(loadString, 'checkown').split(',');
		savedInfo['drops']=getStoredStr(loadString, 'drops').split(',');
		savedInfo['reqown']=getStoredStr(loadString, 'reqown').split(',');
		init(1);
	}
}
function getStoredStr(string, id){
	var start=string.indexOf(id+':[')+(id+':[').length;
	return string.substr(start,string.substr(start).indexOf('];'));
}
function saveSettings(){
	var saveString='reqown:['+reqown.join(',')+'];';
	//reqown:[1,1,0,0,0];
	
	var tmpstr_drop=[];
	tmpstr_drop.push(getVal('drops'));
	tmpstr_drop.push(getVal('dropg'));
	saveString+='drops:['+tmpstr_drop.join(',')+'];';
	//drops:[34,34];
	
	var tmpstr_own=[];
	for(var i in names){tmpstr_own.push(document.getElementById('own'+i).checked ? '1':'0');}
	saveString+='checkown:['+tmpstr_own.join(',')+'];';
	//checkown:[1,1,0,0,0];
	
	if (typeof(Storage) !== "undefined") {
		localStorage.setItem("nikki_parrot", saveString);
	}
	document.getElementById('storage').innerHTML=saveString;
}
function resetSettings(){
	localStorage.clear();
	init();
}
function clearCnt(){
	for (var i in wardrobe){
		reqCnt[i]=0;
		parentInd[i]=0;
		childInd[i]=0;
		extraInd[i]=0;
		extraAdded[i]=0;
	}
}
function genFactor2(id,num){
	for (var i in pattern) {
		if (clothesId[pattern[i][1]]==clothesId[id]){//found factor
			for (var j in wardrobe){//mark parent
				if(wardrobe[j]==clothesId[id]){parentInd[j]=1;}
			}
			for (var j in wardrobe){//mark child
				if(wardrobe[j]==clothesId[pattern[i][3]]){
					childInd[j]=1;
					if(pattern[i][4]>1){
						reqCnt[j]+=(pattern[i][4]-1)*num;
						extraInd[j]=1;
						genFactor2(clothesId[pattern[i][3]][2],(pattern[i][4]-1)*num);
					}else if(pattern[i][5]!='染'){
						extraInd[j]=1;
					}else{
						reqCnt[j]+=pattern[i][4]*num;
						genFactor2(clothesId[pattern[i][3]][2],pattern[i][4]*num);
					}
					break;
				}
			}
		}
	}
	for (var j in wardrobe){//not found
		if(wardrobe[j]==clothesId[id]&&!parentInd[j]){childInd[j]=1;break;}
	}
}
/*function updreqown(i){
	if(document.getElementById('reqown'+i)&&getVal('reqown'+i)>0){
		for(var p in pattern){
			if (wardrobe[i][2]==pattern[p][1]){
				for(var j in wardrobe){
					if (wardrobe[j][2]==pattern[p][3]&&!(getVal('reqown'+j)>0)) {
						setVal('reqown'+j, 1);
						updreqown(j);
					}
				}
			}
		}
	}
}*/
function checkall(n){
	var pos=0;
	for (i=0;i<n;i++){
		pos+=setCnt[i];
	}
	if (document.getElementById('all'+n).checked){
		for (i=pos;i<pos+setCnt[n];i++){
			document.getElementById('own'+i).checked=true;
		}
	}else{
		for (i=pos;i<pos+setCnt[n];i++){
			document.getElementById('own'+i).checked=false;
		}
	};
	calc();
}
function getVal(id){
	return noNaN(parseInt(document.getElementById(id).value));
}
function setVal(id,val){
	document.getElementById(id).value=val;
}
function noNaN( n ) {
	return isNaN( n ) ? 0 : n;
}
function td(text,attr){
	return '<td'+(attr?' '+attr:'')+'>'+text+'</td>';
}
function tr(text,attr){
	return '<tr'+(attr?' '+attr:'')+'>'+text+'</tr>';
}
function remark(text){
	return '<span class="remark">'+text+'</span>';
}
function inputBox(id,onchange,size){
	return '<input type="text" id="'+id+'" onkeyup='+onchange+(size?' size="'+size+'"':'')+'>';
}
function settime(){
	var time_now=new Date().getTime();
	var time_d = Math.max(0,Math.floor((time_end-time_now)/1000/60/60/24));
	var time_h = Math.max(0,Math.floor((time_end-time_now)/1000/60/60)%24);
	var time_m = Math.max(0,Math.floor((time_end-time_now)/1000/60)%60);
	var time_s = Math.max(0,Math.floor((time_end-time_now)/1000)%60);
	document.getElementById("showTime").innerHTML = time_d + "天" + time_h + "时" + time_m + "分" + time_s + "秒";
};
</script>
</head>
<body>
<div class="myframe" >
<p align="center" class="title1">
活动·鹦鹉公主计算器
</p>
<hr class="mhr">
<p class="normal">
	<span class="title3">更新时间：</span><span id="lastupd">2016-8-24</span><br>
	<span class="title3">更新人员：</span>Rean翎
</p>
<hr class="mhr">
<p align="center">
距离活动结束还有　<span id="showTime"></span><br>
<button onclick="saveSettings()">保存设置</button><button onclick="loadSettings()">读取设置</button><!--<button onclick="resetSettings()">清除缓存</button>-->
</p>
<p align="center" id="table"></p>
<p align="center" id="drop"></p>
<p align="center" id="calcres"></p>
<p align="center" id="input"></p>
<p align="center" id="storage" style="display:none"></p>
</div>
</body>
</html>
